services:
  db:
    image: postgres:16-alpine
    container_name: dogcatcher-db
    environment:
      POSTGRES_DB: dogcatcher
      POSTGRES_USER: dogcatcher
      POSTGRES_PASSWORD: dogcatcher123
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dogcatcher"]
      interval: 10s
      timeout: 5s
      retries: 5

  web:
    build: ./app
    container_name: dogcatcher-web
    env_file:
      - .env
    environment:
      DATABASE_URL: postgresql://dogcatcher:dogcatcher123@db:5432/dogcatcher
      SECRET_KEY: ${DOGCATCHER_SECRET_KEY:-change-this-in-production}
      FLASK_DEBUG: ${FLASK_DEBUG:-false}
      API_KEYS: ${DOGCATCHER_API_KEYS:-}
      API_KEY_REQUIRED: ${API_KEY_REQUIRED:-true}
    # Direct port access (bypasses proxy)
    ports:
      - "5001:5000"
    volumes:
      - ./app:/app
      - uploads:/app/static/uploads
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped

  # Nginx Proxy for multi-protocol routing
  proxy:
    build: ./proxy
    container_name: dogcatcher-proxy
    env_file:
      - .env
    environment:
      PROXY_MODE: ${PROXY_MODE:-dev}
      ENABLE_HTTPS: ${ENABLE_HTTPS:-false}
      ENABLE_MTLS: ${ENABLE_MTLS:-false}
      DOMAIN: ${DOMAIN:-localhost}
    ports:
      - "8080:80"     # HTTP / Multi-protocol routes
      - "8443:443"    # HTTPS
      - "8444:8443"   # mTLS (strict)
    volumes:
      - ./proxy/nginx-dev.conf:/etc/nginx/nginx.conf:ro
      - ./proxy/conf.d:/etc/nginx/conf.d:ro
      - ./certs/mtls:/etc/nginx/certs/mtls:ro
      - letsencrypt:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    depends_on:
      - web
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 3s
      retries: 3

  citizen:
    build: ./citizen-app
    container_name: model-citizen
    env_file:
      - .env
    environment:
      SECRET_KEY: ${CITIZEN_SECRET_KEY:-citizen-secret-change-in-production}
      FLASK_DEBUG: ${FLASK_DEBUG:-false}
      # Use proxy for API access with different auth modes
      API_GATEWAY_URL: ${API_GATEWAY_URL:-http://proxy/plain}
      DOGCATCHER_PUBLIC_URL: ${DOGCATCHER_PUBLIC_URL:-http://localhost:8080}
    ports:
      - "5002:5000"
    volumes:
      - ./citizen-app:/app
    depends_on:
      - proxy
    restart: unless-stopped

volumes:
  postgres_data:
  uploads:
  letsencrypt:
  certbot_www:
