{% extends 'base.html' %}

{% block title %}Hatch Client Certificate{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">
        <div class="page-title-icon">ü•ö</div>
        Hatch Client Certificate
    </h1>
    <p class="page-description">Create a new client certificate for mTLS authentication</p>
</div>

<div class="card" style="max-width: 700px;">
    <form method="post">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="id_name" class="form-label">ü¶ñ Certificate Name</label>
            {{ form.name }}
            <p class="form-help">A friendly name for this egg (e.g., "Rex's Client Cert")</p>
        </div>
        
        <div class="form-group">
            <label for="id_issuing_ca" class="form-label">ü¶¥ Issuing CA</label>
            {{ form.issuing_ca }}
            <p class="form-help">Select which CA dino will sign this certificate</p>
            <div id="root-ca-warning" class="alert alert-warning mt-2" style="display: none;">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <div>
                    <strong>Best Practice Warning:</strong> You've selected a Root CA. 
                    It's recommended to use an Intermediate CA for signing certificates. 
                    This protects your Root CA and limits damage if the signing key is compromised.
                </div>
            </div>
        </div>
        
        <hr style="border: none; border-top: 2px dashed var(--border-color); margin: 2rem 0;">
        
        <h4 style="margin-bottom: 1rem;">ü¶ï Client Information</h4>
        
        <div class="form-group">
            <label for="id_common_name" class="form-label">Common Name (CN)</label>
            {{ form.common_name }}
            <p class="form-help">Client identifier (e.g., rex@dinotech.com or trex-api-client)</p>
        </div>
        
        <div class="form-group">
            <label for="id_email" class="form-label">Email Address</label>
            {{ form.email }}
            <p class="form-help">Email will be added to Subject Alternative Names</p>
        </div>
        
        <hr style="border: none; border-top: 2px dashed var(--border-color); margin: 2rem 0;">
        
        <h4 style="margin-bottom: 1rem;">üìã Subject Details (optional)</h4>
        
        <div class="cert-detail-grid">
            <div class="form-group">
                <label for="id_organization" class="form-label">Organization (O)</label>
                {{ form.organization }}
            </div>
            
            <div class="form-group">
                <label for="id_organizational_unit" class="form-label">Organizational Unit (OU)</label>
                {{ form.organizational_unit }}
            </div>
        </div>
        
        <div class="cert-detail-grid">
            <div class="form-group">
                <label for="id_country" class="form-label">Country (C)</label>
                {{ form.country }}
            </div>
            
            <div class="form-group">
                <label for="id_state" class="form-label">State/Province (ST)</label>
                {{ form.state }}
            </div>
            
            <div class="form-group">
                <label for="id_locality" class="form-label">Locality/City (L)</label>
                {{ form.locality }}
            </div>
        </div>
        
        <hr style="border: none; border-top: 2px dashed var(--border-color); margin: 2rem 0;">
        
        <h4 style="margin-bottom: 1rem;">‚öôÔ∏è Certificate Options</h4>
        
        <div class="cert-detail-grid">
            <div class="form-group">
                <label for="id_validity_days" class="form-label">Validity Period (days)</label>
                {{ form.validity_days }}
                <p class="form-help">Max: 1095 days (3 dino years)</p>
            </div>
            
            <div class="form-group">
                <label for="id_key_size" class="form-label">Key Size</label>
                {{ form.key_size }}
            </div>
        </div>
        
        <div class="form-group">
            <label class="flex items-center gap-1">
                {{ form.generate_p12 }}
                Generate PKCS#12 bundle (.p12)
            </label>
            <p class="form-help" style="margin-left: 1.5rem;">Creates a .p12 file for easy import into browsers and apps</p>
        </div>
        
        <div class="flex gap-2 mt-4">
            <button type="submit" class="btn btn-accent btn-lg">
                üê£ Hatch Client Certificate
            </button>
            <a href="{% url 'client_cert_list' %}" class="btn btn-outline btn-lg">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Root CA warning - check if selected CA is a Root CA
document.addEventListener('DOMContentLoaded', function() {
    var caSelect = document.getElementById('id_issuing_ca');
    var warning = document.getElementById('root-ca-warning');
    
    // Root CA IDs passed from server (CAs where is_root=True)
    var rootCaIds = [{% for ca in form.issuing_ca.field.queryset %}{% if ca.is_root %}'{{ ca.pk }}',{% endif %}{% endfor %}];
    
    function checkRootCA() {
        if (caSelect && warning) {
            var selectedId = caSelect.value;
            if (rootCaIds.indexOf(selectedId) !== -1) {
                warning.style.display = 'flex';
            } else {
                warning.style.display = 'none';
            }
        }
    }
    
    if (caSelect) {
        caSelect.addEventListener('change', checkRootCA);
        checkRootCA(); // Check on page load
    }
});
</script>
{% endblock %}
