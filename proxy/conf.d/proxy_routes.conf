# Dogcatcher API Gateway - Route Configurations
# Each path prefix corresponds to a different authentication method

# ============================================
# /plain - No authentication required
# ============================================
location /plain/ {
    # No authentication - direct access
    proxy_set_header X-Auth-Mode "plain";
    proxy_set_header X-Auth-Verified "true";
    
    include /etc/nginx/conf.d/proxy_common.conf;
    
    # Strip /plain prefix and proxy to API
    rewrite ^/plain/(.*)$ /api/$1 break;
    proxy_pass http://dogcatcher_backend;
}

# ============================================
# /apikey - API Key authentication
# ============================================
location /apikey/ {
    # Check for API key header
    if ($http_x_api_key = "") {
        return 401 '{"error": "API key required", "message": "Please provide X-API-Key header"}';
    }
    
    # Set auth headers - actual validation done by backend
    proxy_set_header X-Auth-Mode "apikey";
    proxy_set_header X-Auth-Verified "pending";
    # Forward the API key to backend for validation
    proxy_set_header X-API-Key $http_x_api_key;
    
    include /etc/nginx/conf.d/proxy_common.conf;
    
    # Strip /apikey prefix and proxy to API
    rewrite ^/apikey/(.*)$ /api/$1 break;
    proxy_pass http://dogcatcher_backend;
}

# ============================================
# /mtls - Mutual TLS authentication
# ============================================
location /mtls/ {
    # Require valid client certificate
    if ($ssl_client_verify != SUCCESS) {
        return 403 '{"error": "mTLS required", "message": "Valid client certificate required"}';
    }
    
    # Set auth headers with certificate info
    proxy_set_header X-Auth-Mode "mtls";
    proxy_set_header X-Auth-Verified "true";
    proxy_set_header X-Client-Cert-DN $ssl_client_s_dn;
    proxy_set_header X-Client-Cert-Issuer $ssl_client_i_dn;
    proxy_set_header X-Client-Cert-Serial $ssl_client_serial;
    proxy_set_header X-Client-Cert-Fingerprint $ssl_client_fingerprint;
    
    include /etc/nginx/conf.d/proxy_common.conf;
    
    # Strip /mtls prefix and proxy to API
    rewrite ^/mtls/(.*)$ /api/$1 break;
    proxy_pass http://dogcatcher_backend;
}

# ============================================
# /jwt - JWT Bearer token authentication
# ============================================
location /jwt/ {
    # Check for Authorization header with Bearer token
    if ($http_authorization = "") {
        return 401 '{"error": "JWT required", "message": "Please provide Authorization: Bearer <token> header"}';
    }
    
    # Validate JWT format (Bearer prefix)
    if ($http_authorization !~ "^Bearer ") {
        return 401 '{"error": "Invalid authorization", "message": "Authorization header must be: Bearer <token>"}';
    }
    
    # For full JWT validation, use auth_request to validation service
    # or nginx-plus JWT module, or OpenResty with lua-resty-jwt
    auth_request /auth/jwt/validate;
    auth_request_set $jwt_sub $upstream_http_x_jwt_sub;
    auth_request_set $jwt_claims $upstream_http_x_jwt_claims;
    
    # Set auth headers
    proxy_set_header X-Auth-Mode "jwt";
    proxy_set_header X-Auth-Verified "true";
    proxy_set_header X-JWT-Subject $jwt_sub;
    proxy_set_header X-JWT-Claims $jwt_claims;
    
    include /etc/nginx/conf.d/proxy_common.conf;
    
    # Strip /jwt prefix and proxy to API
    rewrite ^/jwt/(.*)$ /api/$1 break;
    proxy_pass http://dogcatcher_backend;
}

# ============================================
# /oidc - OpenID Connect authentication
# ============================================
location /oidc/ {
    # OIDC typically uses auth_request to OAuth2 Proxy or similar
    auth_request /auth/oidc/validate;
    auth_request_set $oidc_user $upstream_http_x_auth_request_user;
    auth_request_set $oidc_email $upstream_http_x_auth_request_email;
    auth_request_set $oidc_groups $upstream_http_x_auth_request_groups;
    
    # Set auth headers
    proxy_set_header X-Auth-Mode "oidc";
    proxy_set_header X-Auth-Verified "true";
    proxy_set_header X-OIDC-User $oidc_user;
    proxy_set_header X-OIDC-Email $oidc_email;
    proxy_set_header X-OIDC-Groups $oidc_groups;
    
    include /etc/nginx/conf.d/proxy_common.conf;
    
    # Strip /oidc prefix and proxy to API
    rewrite ^/oidc/(.*)$ /api/$1 break;
    proxy_pass http://dogcatcher_backend;
}

# ============================================
# Auth validation endpoints (internal)
# ============================================

# JWT validation endpoint
# Note: Replace with actual JWT validation service in production
location = /auth/jwt/validate {
    internal;
    # Stub response - always allow (replace with real validator in production)
    return 200;
}

# OIDC validation endpoint (OAuth2 Proxy)
# Note: Replace with actual OAuth2 Proxy in production
location = /auth/oidc/validate {
    internal;
    # Stub response - always allow (replace with real validator in production)
    return 200;
}

# OAuth2 Proxy callback and sign-in
# Note: Disabled - no OAuth2 proxy configured
location /oauth2/ {
    return 501 "OAuth2 proxy not configured";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# ============================================
# Direct API access (for internal/legacy use)
# ============================================
location /api/ {
    # Direct API access - uses backend's own authentication
    proxy_set_header X-Auth-Mode "direct";
    
    include /etc/nginx/conf.d/proxy_common.conf;
    proxy_pass http://dogcatcher_backend;
}

# ============================================
# Static files and health checks
# ============================================

location /static/ {
    proxy_pass http://dogcatcher_backend;
    proxy_cache_valid 200 1d;
}

location /health {
    access_log off;
    return 200 '{"status": "healthy", "service": "dogcatcher-proxy"}';
    add_header Content-Type application/json;
}

# API documentation
location /api/docs {
    proxy_pass http://dogcatcher_backend;
}

# Root redirect to docs
location = / {
    return 302 /api/docs;
}
