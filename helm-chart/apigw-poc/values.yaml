# Default values for apigw-poc
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Global settings
global:
  # Domain suffix for all ingresses
  domainSuffix: "jim00.pd.test-rig.nl"
  
  # TLS/SSL configuration
  tls:
    enabled: true
    # ClusterIssuer name for cert-manager
    clusterIssuer: "letsencrypt-prod"

# Producer application configuration
producer:
  enabled: true
  
  name: producer
  namespace: producer
  
  replicaCount: 1
  
  image:
    repository: jimleitch/producer-app
    tag: latest
    pullPolicy: Always
  
  service:
    type: ClusterIP
    port: 80
    targetPort: 5000
  
  env:
    PORT: "5000"
  
  resources: {}
    # limits:
    #   cpu: 500m
    #   memory: 512Mi
    # requests:
    #   cpu: 250m
    #   memory: 256Mi
  
  livenessProbe:
    httpGet:
      path: /health
      port: 5000
    initialDelaySeconds: 10
    periodSeconds: 10
  
  readinessProbe:
    httpGet:
      path: /health
      port: 5000
    initialDelaySeconds: 5
    periodSeconds: 5
  
  ingress:
    enabled: true
    className: nginx
    # Host will be: producer.{{ .Values.global.domainSuffix }}
    annotations:
      cert-manager.io/cluster-issuer: "{{ .Values.global.tls.clusterIssuer }}"

# Consumer application configuration
consumer:
  enabled: true
  
  name: consumer
  namespace: consumer
  
  replicaCount: 1
  
  image:
    repository: jimleitch/consumer-app
    tag: latest
    pullPolicy: Always
  
  service:
    type: ClusterIP
    port: 80
    targetPort: 5001
  
  env:
    PORT: "5001"
    # Producer API URL points to Kong Gateway
    PRODUCER_API_URL: "http://kong-proxy.kong:8000/producer"
  
  resources: {}
    # limits:
    #   cpu: 500m
    #   memory: 512Mi
    # requests:
    #   cpu: 250m
    #   memory: 256Mi
  
  livenessProbe:
    httpGet:
      path: /health
      port: 5001
    initialDelaySeconds: 10
    periodSeconds: 10
  
  readinessProbe:
    httpGet:
      path: /health
      port: 5001
    initialDelaySeconds: 5
    periodSeconds: 5
  
  ingress:
    enabled: true
    className: nginx
    # Host will be: consumer.{{ .Values.global.domainSuffix }}
    annotations:
      cert-manager.io/cluster-issuer: "{{ .Values.global.tls.clusterIssuer }}"

# Kong API Gateway configuration
kong:
  enabled: true
  
  name: kong-proxy
  namespace: kong
  
  replicaCount: 1
  
  image:
    repository: kong
    tag: "3.4"
    pullPolicy: IfNotPresent
  
  service:
    type: ClusterIP
    ports:
      proxy: 8000
      admin: 8001
  
  env:
    KONG_DATABASE: "off"
    KONG_DECLARATIVE_CONFIG: "/kong/declarative/kong.yml"
    KONG_PROXY_ACCESS_LOG: "/dev/stdout"
    KONG_ADMIN_ACCESS_LOG: "/dev/stdout"
    KONG_PROXY_ERROR_LOG: "/dev/stderr"
    KONG_ADMIN_ERROR_LOG: "/dev/stderr"
    KONG_ADMIN_LISTEN: "0.0.0.0:8001"
    KONG_PROXY_LISTEN: "0.0.0.0:8000"
  
  # Kong declarative configuration
  config:
    _format_version: "3.0"
    _transform: true
    services:
      - name: producer-service
        url: http://producer-service.producer:80
        routes:
          - name: producer-route
            paths:
              - /producer
            strip_path: true
      - name: consumer-service
        url: http://consumer-service.consumer:80
        routes:
          - name: consumer-route
            paths:
              - /consumer
            strip_path: true
  
  resources: {}
    # limits:
    #   cpu: 1000m
    #   memory: 1Gi
    # requests:
    #   cpu: 500m
    #   memory: 512Mi
  
  ingress:
    enabled: true
    className: nginx
    # Host will be: kong.{{ .Values.global.domainSuffix }}
    annotations:
      cert-manager.io/cluster-issuer: "{{ .Values.global.tls.clusterIssuer }}"
