# Docker Compose override for Azure VM deployment
# Usage: docker compose -f docker-compose.yml -f docker-compose.azure.yml up -d
#
# This override:
#   - Exposes HTTPS on standard port 443
#   - Exposes HTTP on standard port 80 (for Let's Encrypt and redirects)
#   - Uses production Nginx configuration
#   - Removes development volume mounts
#   - Disables direct app port access

services:
  web:
    # Remove direct port access in production
    ports: []
    # Remove development volume mount
    volumes:
      - uploads:/app/static/uploads

  proxy:
    environment:
      PROXY_MODE: prod
      ENABLE_HTTPS: "true"
      ENABLE_MTLS: "false"
    ports:
      - "80:80"       # HTTP (Let's Encrypt + redirect to HTTPS)
      - "443:443"     # HTTPS (main access)
      # - "8443:8443"   # mTLS (optional - uncomment if needed)
    # Override volumes completely - mount production nginx.conf
    volumes:
      - ./proxy/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./proxy/conf.d:/etc/nginx/conf.d:ro
      # SSL certificates (self-signed or Let's Encrypt)
      - ./certs/ssl/server.crt:/etc/nginx/certs/server.crt:ro
      - ./certs/ssl/server.key:/etc/nginx/certs/server.key:ro
      # CA cert for mTLS (dummy if not using mTLS)
      - ./certs/ssl/ca.crt:/etc/nginx/certs/ca.crt:ro
      - letsencrypt:/etc/letsencrypt
      - certbot_www:/var/www/certbot

  citizen:
    # Remove direct port access in production
    ports: []
    volumes: []
    environment:
      SECRET_KEY: ${CITIZEN_SECRET_KEY:-citizen-secret-change-in-production}
      FLASK_DEBUG: "false"
      API_GATEWAY_URL: http://proxy/plain
      DOGCATCHER_PUBLIC_URL: https://${DOMAIN:-localhost}
